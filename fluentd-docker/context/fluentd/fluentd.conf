<source>
    @type tail
    path /mnt/docker-containers/*/*-json.log
    pos_file /mnt/output/docker.pos
    tag docker.container
    <parse>
        @type json
        time_type string
        time_format "%Y-%m-%dT%H:%M:%S.%NZ"
        time_key time
    </parse>
</source>

<filter docker.container>
    @type record_transformer
    enable_ruby
    <record>
        container_id ${record.dig("attrs", "tag")}
    </record>
    remove_keys attrs
</filter>

<filter docker.container>
    @type parser
    <parse>
        @type json
        # avoid re-setting timestamp for log
        time_key zzzzzzztime
    </parse>
    key_name log
    reserve_data true
    remove_key_name_field true
    hash_value_field entry
</filter>

<filter docker.container>
    @type grep
    <exclude>
        key $.entry.userAgent
        pattern /Varnish Health Probe/
    </exclude>
</filter>

<label @ERROR>
    <match docker.**>
        @type file
        path /mnt/output/docker.%Y%m%d%H%M.unparsed
        append true
        <format>
            @type json
        </format>
        <buffer>
            timekey 5m
            timekey_use_utc true
            timekey_wait 30s
        </buffer>
    </match>
</label>

<label @FLUENT_LOG>
    <match **>
        @type file
        path /mnt/output/fluentd.%Y%m%d%H%M
        append true
        <format>
            @type json
        </format>
        <buffer>
            timekey 5m
            timekey_use_utc true
            timekey_wait 30s
        </buffer>
    </match>
</label>

<match docker.**>
    @type copy 
    <store>
        @type file
        path /mnt/output/docker.%Y%m%d%H%M
        append true
        <format>
            @type json
        </format>
        <buffer>
            timekey 5m
            timekey_use_utc true
            timekey_wait 30s
        </buffer>
    </store>
    <store>
        @type stdout
    </store>
</match>